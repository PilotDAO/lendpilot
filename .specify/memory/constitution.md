<!--
Sync Impact Report:
- Version: 1.0.0 (initial)
- Created: 2026-01-11
- Project: Aavescan Clone
- Status: Initial constitution based on spec-temp.md requirements
-->

# Конституция проекта: Aavescan Clone

**Версия:** 1.0.0  
**Дата ратификации:** 2026-01-11  
**Последнее изменение:** 2026-01-11  
**Статус:** Активна

---

## 1. Принципы

### 1.1. Источник истины

**Правило:** Единственный авторитет по требованиям — файл `spec-temp.md` в корне репозитория.

**Обязательства:**
- Запрещено упрощать или выбрасывать детали из SPEC.
- При неопределённости — задавать вопросы, а не додумывать.
- Любые интерпретации должны быть явно согласованы с владельцем проекта.

**Рационал:** SPEC содержит проверенные детали и решения. Отклонения ведут к ошибкам и переделкам.

### 1.2. Политика "не выдумывать"

**Правило:** Запрещено изобретать GraphQL поля, endpoint'ы, формулы, хардкоды, UI поведение, если это не:
- (а) явно описано в SPEC, или
- (б) доказано preflight'ом с явным согласованием.

**Запрещённые практики:**
- "Молчаливые" подмены данных (рисовать нули, генерировать ряды, тянуть last value).
- Добавление полей/методов без проверки в схеме/документации.
- Изменение формул расчёта без согласования.

**Рационал:** Непроверенные предположения приводят к несовместимости с реальными API и некорректным данным.

---

## 2. Разрешённые и запрещённые источники данных

### 2.1. Whitelist источников (строгий, только server-side)

**Разрешённые источники:**

1. **AaveKit GraphQL API**
   - URL: `https://api.v3.aave.com/graphql`
   - Использование: текущее состояние рынка/резерва, метаданные токенов, опционально история APY
   - Доступ: только через BFF/server-side

2. **The Graph Gateway (Aave V3 Subgraph)**
   - URL шаблон: `https://gateway.thegraph.com/api/${GRAPH_API_KEY}/subgraphs/id/${AAVE_SUBGRAPH_ID}`
   - Использование: снапшоты, история, индексы
   - Доступ: только через BFF/server-side

3. **Ethereum RPC (failover, server-side)**
   - Приоритетный список:
     - `https://eth.drpc.org`
     - `https://eth.llamarpc.com`
     - `https://rpc.ankr.com/eth`
     - `https://ethereum-rpc.publicnode.com`
   - Резервный (нестабильный, только как последний):
     - `https://cloudflare-eth.com`
   - Использование: timestamp → blockNumber для снапшотов

**Правила:**
- Любой новый источник запрещён без отдельного preflight и явного согласования.
- Все запросы к внешним API должны проходить через BFF слой.
- API ключи никогда не должны попадать на клиент.

### 2.2. Запрещённые источники

- Прямые запросы к The Graph из клиентского кода
- Любые публичные API, не указанные в whitelist
- Локальные моки данных в production коде (только для тестов)

---

## 3. Подтверждённые инварианты (нельзя менять)

### 3.1. Subgraph структура

**Инвариант:** `Pool.id ≠ Pool.pool` (pool address)

- `Pool.id` — идентификатор сущности в субграфе
- `Pool.pool` — адрес контракта пула
- Фильтрация резервов: `reserves(where:{ pool: <Pool.id> })`, **не** по адресу пула

**Пример (Ethereum V3):**
- `Pool.id = 0x2f39d218133afab8f2b819b1066c7e434ad94e9e`
- `Pool.pool = 0x87870bca3f3fd6335c3f4ce8392d69350b4fa4e2`

### 3.2. Маппинг poolAddress → poolEntityId

**Инвариант:** Маппинг выполняется через запрос:
```graphql
pools(where: { pool: <poolAddress> }) -> Pool.id
```

Где `Pool.id` используется как `poolEntityId` для дальнейших запросов.

### 3.3. Ethereum V3 подтверждённые значения

- `poolEntityId`: `0x2f39d218133afab8f2b819b1066c7e434ad94e9e`
- `poolAddress`: `0x87870bca3f3fd6335c3f4ce8392d69350b4fa4e2`
- `reserves(block)` возвращает ~59–60 активов (зависит от даты)

### 3.4. Формат цены

**Инвариант:** `price.priceInEth` трактуется как `USD * 1e8` (priceBase=USDx1e8)

- Применимо для Ethereum V3 deployment
- Для других сетей требуется preflight проверка
- Формула: `priceUSD = price.priceInEth / 1e8`

### 3.5. AaveKit GraphQL схема

**Подтверждённые элементы:**

- `TimeWindow` enum: `LAST_DAY`, `LAST_WEEK`, `LAST_MONTH`, `LAST_SIX_MONTHS`, `LAST_YEAR`
- Доступные поля: `Currency.imageUrl`, `Currency.name`, `Currency.symbol`, `Currency.decimals`
- Запросы: `markets`, `market`, `reserve`, `borrowAPYHistory`, `supplyAPYHistory`

---

## 4. Data Gates (Preflight + Data Contracts)

### 4.1. Обязательные preflight проверки

**Правило:** Нельзя начинать крупную реализацию без прохождения всех preflight проверок.

**Чеклист preflight:**

1. **AaveKit GraphQL**
   - [ ] Доступность endpoint
   - [ ] Наличие `markets`, `market`, `reserve` запросов
   - [ ] Наличие `borrowAPYHistory`, `supplyAPYHistory`
   - [ ] Корректность `TimeWindow` enum

2. **The Graph Subgraph**
   - [ ] Доступность через gateway
   - [ ] `_meta.hasIndexingErrors = false`
   - [ ] Работает маппинг `poolAddress → Pool.id`
   - [ ] `reserves(block:{number})` возвращает непустой результат

3. **RPC Failover**
   - [ ] Получение latest block работает
   - [ ] `timestamp → blockNumber` для "вчера 23:59:59Z" не падает
   - [ ] Failover на следующий RPC работает при ошибке

4. **Отчётность**
   - [ ] Preflight генерирует короткий отчёт/артефакт в репозиторий
   - [ ] Отчёт содержит использованные endpoints, проверенные значения, ошибки (если есть)

### 4.2. Data Contracts (контракты данных)

**Правило:** Все данные должны соответствовать явным контрактам.

**Требования:**

1. **Нормализация адресов**
   - Все адреса хранятся и сравниваются в lowercase
   - Валидация формата: `0x` + 40 hex символов

2. **Big-number корректность**
   - Всегда учитывать `decimals` при конвертации
   - Не использовать JS `float` для raw onchain integer значений
   - Применять `BigInt` + decimal library (`big.js` или `decimal.js`) для расчётов

3. **Детерминизм снапшотов**
   - Daily точка = конец дня UTC (23:59:59Z)
   - `blockNumber = blockAtOrBefore(timestamp)` через RPC failover
   - Запрос: `reserves(block:{number: blockNumber})`

---

## 5. Устойчивость (Cache/Retry)

### 5.1. Кэширование

**Обязательные требования:**

- Server-side caching с TTL обязателен для всех upstream calls
- TTL по типам данных:
  - Live данные (market/reserve): 30–60 секунд
  - Daily snapshots: 6–24 часа
  - Mapping poolAddress→poolEntityId: 24 часа
- Размер кэша: максимум 1000 записей на тип данных
- Стратегия eviction: LRU (Least Recently Used)

### 5.2. Retry и Backoff

**Обязательные требования:**

- Retry на 429/5xx ошибках обязателен
- Экспоненциальный backoff:
  - Максимум 3 попытки
  - Интервалы: 1s, 2s, 4s
- При наличии кэша — отдавать stale (stale-if-error)
- Логирование всех попыток с уровнем WARN

### 5.3. Failover

**RPC Failover:**
- При ошибке RPC: автоматический переход на следующий URL из списка
- Логирование использованного RPC и упавших
- Если все RPC упали: возвращать ошибку с деталями последней попытки

---

## 6. Schema Lock и Codegen

### 6.1. Версионирование схем

**Правило:** В репозитории хранить и версионировать интроспекцию схем.

**Требования:**

- Файлы схем в репозитории:
  - `schema/aavekit_schema.json` — интроспекция AaveKit GraphQL
  - `schema/aave_subgraph_schema.json` — интроспекция Aave Subgraph
- Версионирование через git
- Обновление при изменении upstream схем

### 6.2. Codegen

**Правило:** Использовать типы (graphql-codegen) для всех запросов.

**Требования:**

- Генерация TypeScript типов из схем
- Типизированные запросы (без строковых запросов)
- При изменении схемы:
  - Обновить артефакты схем
  - Обновить сгенерированные типы
  - Прогнать preflight

---

## 7. Тестовые ворота

### 7.1. Unit тесты (обязательны)

**Обязательные тесты:**

- Decimals conversion (токены → USD)
- USD conversion (USDx1e8 → USD)
- Расчёт Δ30d (изменение за 30 дней)
- Компараторы сортировки (null/undefined handling)
- Форматирование процентов (без "pp", только "%")

### 7.2. Integration тесты

**Обязательные тесты:**

- BFF API endpoints с моками внешних API
- Обработка ошибок (429, 5xx, timeout)
- Кэширование (TTL, eviction)
- Rate limiting

### 7.3. E2E Smoke тесты (обязательны)

**Обязательные сценарии:**

- `/ethereum-v3` — загрузка и отображение таблицы
- `/stablecoins` — фильтрация и отображение
- `/ethereum-v3/<asset>` — страница актива с данными

**Правило:** Реализация не считается завершённой, пока все обязательные тесты не проходят.

---

## 8. Продуктовые и UX запреты

### 8.1. Pro функции

**Запрещено:**
- Логин/регистрация
- Подписки/платные ограничения
- Pro-баннеры/апсейл
- Закрытые метрики

### 8.2. Incentives

**Запрещено везде:**
- Merkl incentives
- ACI Merit Program
- Reward APR
- Total APR (показывать только Protocol APR)
- Бейджи/тултипы про incentives

### 8.3. Экспорт

**Запрещено:**
- Экспорт графиков в PNG/JPEG
- SVG export (не включаем в MVP)

**Разрешено:**
- CSV export (daily/monthly snapshots)

### 8.4. Форматирование

**Запрещено:**
- Использование "pp" (percentage points)
- Дельты показывать только как проценты: `+0.12%` / `-0.34%`

### 8.5. Библиотеки графиков

**Запрещено:**
- Recharts

**Разрешено:**
- Apache ECharts (единственная разрешённая библиотека)

---

## 9. Архитектурные ограничения

### 9.1. Стек (обязательный)

- Next.js App Router
- TypeScript
- TailwindCSS
- TanStack Table (для таблиц с сортировками)
- Apache ECharts (для графиков)
- zod (валидация данных)
- big.js или decimal.js (работа с большими числами)

### 9.2. BFF/Server слой (обязателен)

**Правило:** BFF/server слой обязателен.

**Требования:**

- Нельзя делать запросы к The Graph из клиента
- Нельзя светить `GRAPH_API_KEY` на клиенте
- Все внешние API запросы через server-side routes/API handlers
- Централизация кэша, retry, деградации на сервере

### 9.3. Запрет N+1

**Правило:** Market-таблица не должна делать history-запросы на каждую строку в рантайме.

**Требования:**

- Тяжёлые истории обязаны быть backfill/cached
- Предзагрузка данных для таблиц
- Batch запросы где возможно

---

## 10. Безопасность и секреты

### 10.1. Защита секретов

**Правило:** Запрещено логировать секреты.

**Требования:**

- `GRAPH_API_KEY` не должен появляться в логах
- Если ключ засветился — немедленно rotate
- API keys хранятся только в environment variables
- В production использовать secure storage (Vercel Environment Variables и т.п.)

### 10.2. Валидация входных данных

**Требования:**

- Все параметры URL валидируются через zod схемы
- Адреса проверяются на формат (0x + 40 hex символов)
- Market keys проверяются против списка из `data/markets.json`
- При невалидных данных: возвращать 400 с описанием ошибки

### 10.3. Rate Limiting

**Требования:**

- Rate limiting на BFF endpoints:
  - 100 запросов в минуту на IP для live данных
  - 20 запросов в минуту на IP для исторических данных
- При превышении: возвращать 429 с `Retry-After` заголовком

---

## 11. Управление изменениями

### 11.1. Процедура изменений

**Правило:** Любые отклонения от конституции/SPEC требуют явного согласования с владельцем проекта.

**Запрещено:**
- "Автоматические улучшения" без согласования
- Изменение принципов без обсуждения
- Добавление новых источников данных без preflight

### 11.2. Версионирование конституции

**Правило:** Версионирование по Semantic Versioning.

- **MAJOR:** Backward incompatible изменения принципов/правил
- **MINOR:** Добавление новых принципов/разделов
- **PATCH:** Уточнения формулировок, исправления опечаток

### 11.3. Compliance Review

**Требования:**

- При изменении конституции — обновить все зависимые артефакты
- Проверить соответствие SPEC новым правилам
- Обновить preflight если изменились требования к проверкам

---

## 12. Quality Gates

### 12.1. Preflight Gate

**Правило:** Крупная реализация не начинается без прохождения preflight.

### 12.2. Test Gate

**Правило:** Реализация не считается завершённой без прохождения обязательных тестов.

### 12.3. SPEC Compliance Gate

**Правило:** Все требования из `spec-temp.md` должны быть реализованы без упрощений.

---

## Приложение: Ссылки

- SPEC: `spec-temp.md` (корень репозитория)
- Aavescan: https://aavescan.com
- AaveKit GraphQL: https://api.v3.aave.com/graphql
- The Graph Gateway: https://gateway.thegraph.com

---

**Конституция активна с:** 2026-01-11  
**Последнее обновление:** 2026-01-11  
**Версия:** 1.0.0
