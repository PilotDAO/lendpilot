# Проверка свежести данных

## Проблема

На странице `http://localhost:3000/ethereum-v3` график показывает данные из базы данных. Важно понять:
- **Свежие ли это данные** (только что скачанные из API)
- **Или старые данные** (скачанные несколько часов/дней назад)

## Как проверить

### 1. Проверка через скрипт

```bash
# Проверить последние данные в БД
npx tsx scripts/check-latest-db-data.ts
```

Этот скрипт покажет:
- Когда последний раз обновлялись данные
- Последние 5 записей для каждого окна (30d, 6m, 1y)
- Есть ли ошибки в данных (например, borrowed > supplied)

### 2. Проверка через API

```bash
# Получить данные через API
curl "http://localhost:3000/api/v1/market/ethereum-v3/timeseries?window=1y" | jq '.data[-1]'
```

Это покажет последнюю запись в данных.

### 3. Сравнение с текущими данными из API

```bash
# Сравнить данные из БД с текущими данными из AaveKit API
npx tsx scripts/check-data-freshness.ts
```

## Как обновить данные

Если данные старые, нужно запустить синхронизацию:

```bash
# Синхронизировать все рынки
npm run sync:market-data
```

Это займет время (особенно для 1y окна - 365 запросов к Subgraph).

## Автоматическая синхронизация

В `vercel.json` настроен cron на запуск раз в день в полночь (`0 0 * * *`).

Для локальной разработки нужно запускать синхронизацию вручную.

## Что делать, если данные некорректны

1. **Проверить свежесть данных** - возможно, они просто старые
2. **Запустить синхронизацию** - `npm run sync:market-data`
3. **Проверить логи** - посмотреть, есть ли ошибки при сохранении
4. **Проверить расчеты** - убедиться, что данные из Subgraph корректны

## Важно

Данные в графике берутся из БД (`market_timeseries` таблица). Если данные не синхронизировались недавно, график будет показывать старые данные.

Для проверки свежести данных смотрите поле `updatedAt` в таблице `market_timeseries`.
